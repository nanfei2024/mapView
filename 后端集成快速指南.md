# 🚀 后端集成快速指南

## 📦 已为您准备好的内容

### ✅ 前端接口（已完成）

📁 **`src/api/documentApi.ts`** - 完整的 API 接口封装

包含11个主要接口函数：
1. ✅ `uploadAndParseDocument()` - 上传本地文件
2. ✅ `parseDocumentByUrl()` - URL解析
3. ✅ `getDocumentStatus()` - 查询状态
4. ✅ `getDocumentList()` - 获取历史记录（分页）
5. ✅ `getDocumentDetail()` - 获取详情
6. ✅ `deleteDocument()` - 删除记录
7. ✅ `retryParseDocument()` - 重新解析
8. ✅ `getMarkdownContent()` - 获取Markdown内容
9. ✅ `downloadDocumentResult()` - 下载结果
10. ✅ `batchDeleteDocuments()` - 批量删除
11. ✅ `getDocumentStatistics()` - 获取统计

---

## 🎯 后续需要做的事

### 第 1 步：配置后端 API 地址

在项目根目录创建 `.env` 文件：

```env
# 开发环境
VITE_API_BASE_URL=http://localhost:8080/api

# 生产环境（部署时修改）
# VITE_API_BASE_URL=https://your-domain.com/api
```

### 第 2 步：开发后端 API

选择您熟悉的后端技术栈：

#### 选项 A：Node.js (推荐)
```bash
cd backend-example-nodejs
npm install
cp .env.example .env
# 编辑 .env 填写配置
npm run dev
```

#### 选项 B：Python (Flask/FastAPI)
```bash
cd backend-example-python
pip install -r requirements.txt
cp .env.example .env
# 编辑 .env 填写配置
python app.py
```

#### 选项 C：自己实现
参考 **`后端API接口文档.md`** 实现11个接口

---

## 📋 后端开发Checklist

### ☑️ 必须实现的接口

```
□ POST   /api/documents/upload          # 文件上传
□ POST   /api/documents/parse-url       # URL解析
□ GET    /api/documents/:id             # 查询状态
□ GET    /api/documents                 # 获取列表
□ GET    /api/documents/:id/detail      # 获取详情
□ DELETE /api/documents/:id             # 删除记录
□ POST   /api/documents/:id/retry       # 重新解析
□ GET    /api/documents/:id/markdown    # 获取内容
□ GET    /api/documents/:id/download    # 下载结果
□ POST   /api/documents/batch-delete    # 批量删除
□ GET    /api/documents/statistics      # 获取统计
```

### ☑️ 数据库设计

```sql
CREATE TABLE documents (
    id VARCHAR(50) PRIMARY KEY,
    file_name VARCHAR(255) NOT NULL,
    file_size BIGINT NOT NULL,
    file_type VARCHAR(20) NOT NULL,
    status ENUM('pending', 'processing', 'completed', 'failed'),
    source_type ENUM('local', 'url'),
    source_url TEXT,
    upload_time DATETIME NOT NULL,
    completed_time DATETIME,
    result_url TEXT,
    markdown_url TEXT,
    error_message TEXT,
    extracted_pages INT DEFAULT 0,
    total_pages INT DEFAULT 0,
    metadata JSON
);
```

### ☑️ 文件存储结构

```
/uploads/
  /documents/          # 原始文件
    doc_123.pdf
  /results/            # 解析结果
    doc_123.zip
    doc_123/
      auto/
        xxx.md
```

---

## 🧪 测试接口

### 1. 启动后端服务器

```bash
# 示例：Node.js
cd backend-example-nodejs
npm run dev
```

### 2. 启动前端开发服务器

```bash
# 在项目根目录
npm run dev
```

### 3. 测试功能

1. 打开浏览器：http://localhost:5173
2. 点击「地质文档数字化」
3. 上传一个 PDF 文件
4. 观察上传和解析过程
5. 查看历史记录

---

## 🔑 关键点

### 1. CORS 配置

后端需要允许跨域：

```javascript
// Express.js 示例
app.use(cors({
  origin: 'http://localhost:5173',
  credentials: true
}));
```

### 2. 文件大小限制

```javascript
// Express.js 示例
app.use(express.json({ limit: '100mb' }));
app.use(express.urlencoded({ limit: '100mb', extended: true }));
```

### 3. 长时间任务处理

使用消息队列（推荐）或后台任务：

```javascript
// 伪代码
async function uploadDocument(file) {
  // 1. 快速保存文件和创建记录
  const doc = await saveAndCreateRecord(file);
  
  // 2. 添加到任务队列
  await queue.add('parse', { docId: doc.id });
  
  // 3. 立即返回
  return doc;
}

// 后台任务处理器
async function parseTask(job) {
  const { docId } = job.data;
  
  try {
    // 调用 MinerU API
    const result = await callMinerUAPI(docId);
    
    // 更新记录
    await updateDocument(docId, {
      status: 'completed',
      resultUrl: result.url
    });
  } catch (error) {
    await updateDocument(docId, {
      status: 'failed',
      errorMessage: error.message
    });
  }
}
```

---

## 📞 前端调用示例

前端代码已经准备好，只需后端实现接口即可：

```typescript
import documentApi from '@/api/documentApi';

// 上传文件
const handleUpload = async (file: File) => {
  try {
    const record = await documentApi.uploadAndParseDocument(file, 'pdf');
    console.log('上传成功，文档ID:', record.id);
    
    // 轮询状态
    const timer = setInterval(async () => {
      const status = await documentApi.getDocumentStatus(record.id);
      
      if (status.status === 'completed') {
        clearInterval(timer);
        console.log('解析完成！');
      } else if (status.status === 'failed') {
        clearInterval(timer);
        console.error('解析失败:', status.errorMessage);
      }
    }, 3000);
  } catch (error) {
    console.error('上传失败:', error);
  }
};

// 获取历史记录
const getHistory = async () => {
  const history = await documentApi.getDocumentList({
    page: 1,
    pageSize: 10,
    sortBy: 'uploadTime',
    sortOrder: 'desc'
  });
  
  console.log('历史记录:', history.data);
  console.log('总数:', history.total);
};
```

---

## ⚡ 快速测试（无需后端）

如果想先测试前端，可以使用 Mock 数据：

1. 创建 `src/api/documentApi.mock.ts`
2. 导出模拟数据和函数
3. 在开发时切换到 Mock 版本

---

## 📚 相关文档

- **`后端API接口文档.md`** - 完整的 API 规范
- **`src/api/documentApi.ts`** - 前端接口实现
- **`backend-example-nodejs/`** - Node.js 示例
- **`backend-example-python/`** - Python 示例

---

## 🆘 常见问题

### Q: 前端如何知道后端地址？

A: 通过环境变量 `VITE_API_BASE_URL`，已在 `documentApi.ts` 中配置

### Q: 如何处理长时间解析任务？

A: 使用消息队列（Bull/Redis Queue）+ 后台Worker + 轮询状态

### Q: 文件存储在哪里？

A: 可以存储在：
- 本地文件系统（开发）
- 阿里云OSS（生产）
- 腾讯云COS（生产）
- AWS S3（生产）

### Q: 数据库用什么？

A: 推荐：
- 开发：SQLite
- 生产：MySQL/PostgreSQL

---

## ✅ 总结

| 项目 | 状态 | 说明 |
|------|------|------|
| 前端接口 | ✅ 完成 | `src/api/documentApi.ts` |
| 类型定义 | ✅ 完成 | 所有 TypeScript 类型 |
| API 文档 | ✅ 完成 | `后端API接口文档.md` |
| 后端实现 | ⏳ 待开发 | 按文档实现11个接口 |

**您只需要按照 `后端API接口文档.md` 实现后端即可！前端已经完全准备好了！** 🎉

